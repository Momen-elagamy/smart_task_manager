{% extends 'base.html' %}

{% block title %}Projects {% endblock %}

{% block main_content %}
<header class="page-header">
    <div class="header-left">
        <h1>Projects</h1>
        <p>Manage all your projects in one place</p>
    </div>
    <div class="header-right">
        <button class="icon-button" id="view-toggle-btn" title="Toggle View">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
        </button>
        <button class="icon-button" id="filter-btn" title="Filter">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        </button> 
        <button class="primary-button" id="new-project-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Project
        </button>
    </div>
</header>

<!-- Filter Tabs -->
<div class="filter-tabs">
    <button class="tab active" data-filter="all">All Projects</button>
    <button class="tab" data-filter="active">Active</button>
    <button class="tab" data-filter="completed">Completed</button>
    <button class="tab" data-filter="archived">Archived</button>
</div>

<!-- Projects Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-pink));">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
        </div>
        <div class="stat-info">
            <h3 id="total-projects">0</h3>
            <p>Total Projects</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
        </div>
        <div class="stat-info">
            <h3 id="active-projects">0</h3>
            <p>Active Projects</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
        </div>
        <div class="stat-info">
            <h3 id="completed-projects">0</h3>
            <p>Completed</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <div class="stat-info">
            <h3 id="pending-tasks">0</h3>
            <p>Pending Tasks</p>
        </div>
    </div>
</div>

<!-- Projects Grid -->
<div class="projects-container">
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading projects...</p>
    </div>
    
    <div id="projects-grid" class="projects-grid" style="display: none;"></div>
    
    <div id="no-projects" class="no-projects-found" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin: 0 auto 20px; opacity: 0.5;">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        <p>No projects found</p>
        <button class="primary-button" onclick="openAddProjectModal()">
            Create Your First Project
        </button>
    </div>
    
    <div id="error-message" class="error-message" style="display: none;">
        <p>Failed to load projects. Please try again.</p>
        <button class="btn-small" onclick="loadProjects()">Retry</button>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add/Edit Project Modal -->
<div id="new-project-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Create New Project</h2>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <form id="new-project-form">
            <input type="hidden" id="project-id" value="">
            
            <div class="form-group">
                <label for="project-name">Project Name *</label>
                <input 
                    type="text" 
                    id="project-name" 
                    class="form-input" 
                    placeholder="Enter project name" 
                    required
                    minlength="3"
                    maxlength="200"
                    autocomplete="off">
                <small class="form-help-text">Project name must be between 3 and 200 characters</small>
            </div>
            
            <div class="form-group">
                <label for="project-description">Description</label>
                <textarea 
                    id="project-description" 
                    class="form-textarea" 
                    placeholder="Enter project description (optional)" 
                    rows="4"
                    maxlength="1000"></textarea>
                <small class="form-help-text">Optional: Add a detailed description for your project</small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="project-start-date">Start Date</label>
                    <input 
                        type="date" 
                        id="project-start-date" 
                        class="form-input"
                        min="">
                </div>
                
                <div class="form-group">
                    <label for="project-due-date">End Date</label>
                    <input 
                        type="date" 
                        id="project-due-date" 
                        class="form-input"
                        min="">
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 8px;">
                <small class="form-help-text" style="color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Dates are optional. You can set them later.
                </small>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-modal>Cancel</button>
                <button type="submit" class="btn btn-primary" id="submit-project-btn">
                    <span id="submit-btn-text">Create Project</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2 id="delete-modal-title">Delete Project</h2>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <p style="margin-bottom: 24px; color: var(--text-secondary);">Are you sure you want to delete this project? This action cannot be undone.</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-modal>Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete Project</button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
        animation: fadeInUp 0.6s ease;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(6, 182, 212, 0.2);
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .stat-icon svg {
        width: 28px;
        height: 28px;
        color: white;
    }

    .stat-info h3 {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .stat-info p {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .project-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 26px;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .project-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--project-color-1), var(--project-color-2));
    }

    .project-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 16px 40px rgba(6, 182, 212, 0.25);
        border-color: var(--accent-cyan);
    }

    .project-card.completed {
        opacity: 0.8;
    }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        gap: 12px;
    }

    .project-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .project-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--project-color-1), var(--project-color-2));
        flex-shrink: 0;
    }

    .project-icon svg {
        width: 20px;
        height: 20px;
        color: white;
    }

    .project-status {
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        flex-shrink: 0;
    }

    .status-active {
        background: rgba(16, 185, 129, 0.2);
        color: var(--accent-green);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-completed {
        background: rgba(139, 92, 246, 0.2);
        color: var(--accent-purple);
        border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .status-archived {
        background: rgba(107, 114, 128, 0.2);
        color: var(--text-muted);
        border: 1px solid rgba(107, 114, 128, 0.3);
    }

    .project-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 20px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .form-help-text {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.4;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    .form-input:invalid:not(:placeholder-shown) {
        border-color: var(--accent-red);
    }

    .form-input:valid:not(:placeholder-shown) {
        border-color: var(--accent-green);
    }

    .project-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        padding: 16px 0;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
    }

    .project-stat {
        text-align: center;
    }

    .project-stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        display: block;
    }

    .project-stat-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .project-meta {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }

    .project-meta span {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--text-muted);
    }

    .project-meta svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    .project-actions {
        display: flex;
        gap: 8px;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(6, 182, 212, 0.2);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100px);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .projects-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // ============================================
    // Utility Functions (Modal, Toast, Loading)
    // ============================================
    
    // Show toast notification
    function showToast(message, type = 'info', duration = 3000) {
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? 'rgba(16, 185, 129, 0.95)' : type === 'error' ? 'rgba(239, 68, 68, 0.95)' : 'rgba(6, 182, 212, 0.95)'};
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
        `;
        
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    window.showToast = showToast;

    // Show loading overlay
    function showLoadingOverlay(message = 'Loading...') {
        let overlay = document.getElementById('loading-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            overlay.innerHTML = `
                <div style="text-align: center; color: white;">
                    <div class="spinner"></div>
                    <p style="font-size: 16px; font-weight: 600; margin-top: 16px;">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
    }

    // Hide loading overlay
    function hideLoadingOverlay() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.remove();
        }
    }

    // Set button loading state
    function setButtonLoading(button, isLoading, originalText = 'Submit') {
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.textContent;
            button.innerHTML = '<span>Loading...</span>';
        } else {
            button.disabled = false;
            button.innerHTML = `<span>${button.dataset.originalText || originalText}</span>`;
        }
    }

    // Get form data as object
    function getFormData(form) {
        const formData = new FormData(form);
        const data = {};
        for (const [key, value] of formData.entries()) {
            data[key] = value;
        }
        return data;
    }

    // Escape HTML helper
    function escapeHtml(text) {
        if (text === null || typeof text === 'undefined') return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    // Format date helper
    function formatDate(dateString) {
        if (!dateString) return 'No date';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        } catch (e) {
            return 'Invalid date';
        }
    }

    // Handle API errors globally
    function handleAPIError(error, context = '') {
        console.error(`API Error${context ? ' in ' + context : ''}:`, error);
        
        const errorMessage = error.message || 'An error occurred';
        
        // Check if user needs to log in
        if (errorMessage.includes('Authentication') || 
            errorMessage.includes('log in') || 
            errorMessage.includes('HTML instead of JSON')) {
            showToast('Session expired. Please log in again.', 'error', 5000);
            setTimeout(() => {
                window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
            }, 2000);
            return true;
        }
        
        return false;
    }

    // ============================================
    // Project Modal Functions
    // ============================================
    
    // Define openAddProjectModal early so it's available immediately
    function openAddProjectModal() {
        const modal = document.getElementById('new-project-modal');
        const form = document.getElementById('new-project-form');
        
        if (!modal) {
            console.error('Modal new-project-modal not found!');
            alert('Error: Modal not found. Please refresh the page.');
            return;
        }
        
        if (!form) {
            console.error('Form new-project-form not found!');
            alert('Error: Form not found. Please refresh the page.');
            return;
        }
        
        document.getElementById('modal-title').textContent = 'Create New Project';
        const submitBtn = document.getElementById('submit-project-btn') || form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<span>Create Project</span>';
            submitBtn.disabled = false;
        }
        
        // Reset form
        form.reset();
        const projectIdInput = document.getElementById('project-id');
        if (projectIdInput) {
            projectIdInput.value = '';
        }
        
        // Set minimum date to today for date inputs
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.getElementById('project-start-date');
        const endDateInput = document.getElementById('project-due-date');
        if (startDateInput) {
            startDateInput.min = today;
            startDateInput.value = '';
        }
        if (endDateInput) {
            endDateInput.min = today;
            endDateInput.value = '';
        }
        
        // Show modal
        modal.classList.add('active');
        
        // Focus on name input
        setTimeout(() => {
            const nameInput = document.getElementById('project-name');
            if (nameInput) {
                nameInput.focus();
            }
        }, 150);
    }
    
    // Make it globally available immediately
    window.openAddProjectModal = openAddProjectModal;
    
    let projects = [];
    let currentFilter = 'all';
    let projectToDelete = null;

    document.addEventListener('DOMContentLoaded', () => {
        
        // Function to initialize after API is ready
        function initializeAfterAPIReady() {
            if (typeof window.checkAuthentication === 'function' && !checkAuthentication()) {
                return;
            }
            
            // Double check API is available
            if (typeof window.API === 'undefined' || !window.API.projects) {
                console.error('API still not available after wait');
                if (typeof window.showToast === 'function') {
                    window.showToast('API not loaded. Please refresh the page.', 'error');
                } else {
                    alert('API not loaded. Please refresh the page.');
                }
                return;
            }
            
            initializeEventListeners();
            loadProjects();
        }
        
        // Wait for API to be loaded - use event listener for better reliability
        function waitForAPI() {
            if (typeof window.API !== 'undefined' && window.API.projects) {
                initializeAfterAPIReady();
                return;
            }
            
            console.warn('API not loaded yet, waiting...');
            let attempts = 0;
            const maxAttempts = 50; // Wait up to 5 seconds (50 * 100ms)
            
            // Listen for apiReady event
            const apiReadyHandler = () => {
                if (typeof window.API !== 'undefined' && window.API.projects) {
                    window.removeEventListener('apiReady', apiReadyHandler);
                    clearInterval(checkAPI);
                    initializeAfterAPIReady();
                }
            };
            window.addEventListener('apiReady', apiReadyHandler);
            
            // Also poll as fallback
            const checkAPI = setInterval(() => {
                attempts++;
                if (typeof window.API !== 'undefined' && window.API.projects) {
                    window.removeEventListener('apiReady', apiReadyHandler);
                    clearInterval(checkAPI);
                    initializeAfterAPIReady();
                } else if (attempts >= maxAttempts) {
                    window.removeEventListener('apiReady', apiReadyHandler);
                    clearInterval(checkAPI);
                    console.error('API failed to load after waiting');
                    if (typeof window.showToast === 'function') {
                        window.showToast('API not loaded. Please refresh the page.', 'error');
                    } else {
                        alert('API not loaded. Please refresh the page.');
                    }
                }
            }, 100);
        }
        
        waitForAPI();
    });

    function initializeEventListeners() {
        // Add project button
        const newProjectBtn = document.getElementById('new-project-btn');
        if (newProjectBtn) {
            newProjectBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                openAddProjectModal();
            });
        } else {
            console.error('new-project-btn not found!');
        }
        
        // Filter tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                filterProjects();
            });
        });
        
        // Project form submission
        const projectForm = document.getElementById('new-project-form');
        if (projectForm) {
            projectForm.addEventListener('submit', handleProjectSubmit);
        }

        // Modal close buttons
        document.querySelectorAll('[data-close-modal]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = btn.closest('.modal');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Close modal on backdrop click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Update end date min when start date changes
        const startDateInput = document.getElementById('project-start-date');
        const endDateInput = document.getElementById('project-due-date');
        if (startDateInput && endDateInput) {
            startDateInput.addEventListener('change', (e) => {
                if (e.target.value) {
                    endDateInput.min = e.target.value;
                    // If end date is before new start date, clear it
                    if (endDateInput.value && endDateInput.value < e.target.value) {
                        endDateInput.value = '';
                    }
                }
            });
        }
    }

    async function loadProjects() {
        showLoading();
        
        try {
            // Check if API is available
            if (typeof window.API === 'undefined' || !window.API.projects) {
                console.error('API not available');
                showError();
                if (typeof window.showToast === 'function') {
                    window.showToast('API not loaded. Please refresh the page.', 'error');
                } else {
                    alert('API not loaded. Please refresh the page.');
                }
                return;
            }
            
            const response = await window.API.projects.getAll();
            // Handle both response formats
            projects = response.results || response.data || response || [];
            updateStats();
            renderProjects();
        } catch (error) {
            console.error('Error loading projects:', error);
            
            // Check if it's an auth error
            if (handleAPIError(error, 'loadProjects')) {
                showError();
                return;
            }
            
            showError();
            const errorMsg = error.message || 'Failed to load projects. Please try again.';
            if (typeof window.showToast === 'function') {
                window.showToast(errorMsg, 'error');
            } else {
                alert(errorMsg);
            }
        }
    }

    function showLoading() {
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('projects-grid').style.display = 'none';
        document.getElementById('no-projects').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';
    }

    function showError() {
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('projects-grid').style.display = 'none';
        document.getElementById('no-projects').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
    }

    function updateStats() {
        const total = projects.length;
        // Since status is not in model, we'll use a default or calculate from dates
        const active = projects.length; // Default to all active for now
        const completed = 0; // No status field, so we can't determine completed
        const pendingTasks = 0; // Would need to fetch from tasks API
        
        document.getElementById('total-projects').textContent = total;
        document.getElementById('active-projects').textContent = active;
        document.getElementById('completed-projects').textContent = completed;
        document.getElementById('pending-tasks').textContent = pendingTasks;
    }

    function renderProjects() {
        const grid = document.getElementById('projects-grid');
        const filteredProjects = filterProjectsByStatus();
        
        document.getElementById('loading-spinner').style.display = 'none';
        
        if (filteredProjects.length === 0) {
            document.getElementById('projects-grid').style.display = 'none';
            document.getElementById('no-projects').style.display = 'block';
            return;
        }
        
        document.getElementById('no-projects').style.display = 'none';
        document.getElementById('projects-grid').style.display = 'grid';
        
        grid.innerHTML = filteredProjects.map(project => createProjectCard(project)).join('');
    }

    function filterProjectsByStatus() {
        if (currentFilter === 'all') return projects;
        // Since status is not in model, return all for now
        // You can implement custom filtering based on dates or other fields
        return projects;
    }

    function filterProjects() {
        renderProjects();
    }

    function getColorGradient(color) {
        const colors = {
            cyan: ['#06b6d4', '#0891b2'],
            pink: ['#ec4899', '#db2777'],
            purple: ['#8b5cf6', '#7c3aed'],
            green: ['#10b981', '#059669'],
            orange: ['#f59e0b', '#d97706'],
            red: ['#ef4444', '#dc2626']
        };
        return colors[color] || colors.cyan;
    }

    function createProjectCard(project) {
        const [color1, color2] = getColorGradient('cyan'); // Default color since not in model
        const totalTasks = 0; // Would need to fetch from tasks API
        const progress = 0;
        
        return `
            <div class="project-card" 
                 style="--project-color-1: ${color1}; --project-color-2: ${color2};"
                 onclick="openProject('${project.id}')">
                <div class="project-header">
                    <div class="project-title">
                        <div class="project-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <span>${escapeHtml(project.name || 'Unnamed Project')}</span>
                    </div>
                    <span class="project-status status-active">Active</span>
                </div>
                
                ${project.description ? `<p class="project-description">${escapeHtml(project.description)}</p>` : '<p class="project-description" style="color: var(--text-muted); font-style: italic;">No description</p>'}
                
                <div class="project-stats">
                    <div class="project-stat">
                        <span class="project-stat-value">${totalTasks}</span>
                        <span class="project-stat-label">Tasks</span>
                    </div>
                    <div class="project-stat">
                        <span class="project-stat-value">${progress}%</span>
                        <span class="project-stat-label">Progress</span>
                    </div>
                    <div class="project-stat">
                        <span class="project-stat-value">0</span>
                        <span class="project-stat-label">Members</span>
                    </div>
                </div>
                
                <div class="project-meta">
                    ${project.created_at ? `
                        <span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Created: ${formatDate(project.created_at)}
                        </span>
                    ` : ''}
                    ${project.end_date ? `
                        <span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Due: ${formatDate(project.end_date)}
                        </span>
                    ` : ''}
                </div>
                
                <div class="project-actions" onclick="event.stopPropagation()">
                    <button class="btn-small" onclick="event.stopPropagation(); openEditProjectModal('${project.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Edit
                    </button>
                    <button class="btn-small btn-danger" onclick="event.stopPropagation(); openDeleteModal('${project.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
        `;
    }

    function openProject(projectId) {
        // Navigate to project details page or open project modal
        // For now, just open edit modal
        openEditProjectModal(projectId);
    }

    async function openEditProjectModal(projectId) {
        const project = projects.find(p => p.id == projectId);
        if (!project) {
            if (typeof window.showToast === 'function') {
                window.showToast('Project not found', 'error');
            } else {
                alert('Project not found');
            }
            return;
        }
        
        const modal = document.getElementById('new-project-modal');
        const form = document.getElementById('new-project-form');
        if (!modal || !form) {
            console.error('Modal or form not found');
            return;
        }
        
        document.getElementById('modal-title').textContent = 'Edit Project';
        const submitBtn = document.getElementById('submit-project-btn') || form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<span>Update Project</span>';
        }
        
        // Fill form with project data
        document.getElementById('project-id').value = project.id;
        document.getElementById('project-name').value = project.name || '';
        document.getElementById('project-description').value = project.description || '';
        
        // Handle dates - format them properly
        const startDateInput = document.getElementById('project-start-date');
        const endDateInput = document.getElementById('project-due-date');
        
        if (startDateInput && project.start_date) {
            const startDate = new Date(project.start_date);
            startDateInput.value = startDate.toISOString().split('T')[0];
            startDateInput.min = startDate.toISOString().split('T')[0];
        } else if (startDateInput) {
            startDateInput.value = '';
            startDateInput.min = new Date().toISOString().split('T')[0];
        }
        
        if (endDateInput && project.end_date) {
            const endDate = new Date(project.end_date);
            endDateInput.value = endDate.toISOString().split('T')[0];
            // Set min to start date if exists
            if (startDateInput && startDateInput.value) {
                endDateInput.min = startDateInput.value;
            } else {
                endDateInput.min = new Date().toISOString().split('T')[0];
            }
        } else if (endDateInput) {
            endDateInput.value = '';
            if (startDateInput && startDateInput.value) {
                endDateInput.min = startDateInput.value;
            } else {
                endDateInput.min = new Date().toISOString().split('T')[0];
            }
        }
        
        // Focus on name input
        setTimeout(() => {
            const nameInput = document.getElementById('project-name');
            if (nameInput) {
                nameInput.focus();
                nameInput.select();
            }
        }, 100);
        
        modal.classList.add('active');
    }

    function closeProjectModal() {
        const modal = document.getElementById('new-project-modal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    async function handleProjectSubmit(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-project-btn') || e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.innerHTML : '';
        
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>Saving...</span>';
        }
        
        const projectId = document.getElementById('project-id').value;
        const nameInput = document.getElementById('project-name');
        const descriptionInput = document.getElementById('project-description');
        const startDateInput = document.getElementById('project-start-date');
        const endDateInput = document.getElementById('project-due-date');
        
        // Get and validate project name
        const projectName = nameInput.value.trim();
        if (!projectName) {
            const msg = 'Project name is required';
            if (typeof window.showToast === 'function') {
                window.showToast(msg, 'error');
            } else {
                alert(msg);
            }
            nameInput.focus();
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
            return;
        }
        
        if (projectName.length < 3) {
            const msg = 'Project name must be at least 3 characters long';
            if (typeof window.showToast === 'function') {
                window.showToast(msg, 'error');
            } else {
                alert(msg);
            }
            nameInput.focus();
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
            return;
        }
        
        if (projectName.length > 200) {
            const msg = 'Project name must be less than 200 characters';
            if (typeof window.showToast === 'function') {
                window.showToast(msg, 'error');
            } else {
                alert(msg);
            }
            nameInput.focus();
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
            return;
        }
        
        // Validate dates
        const startDate = startDateInput.value || null;
        const endDate = endDateInput.value || null;
        
        if (startDate && endDate) {
            if (new Date(startDate) > new Date(endDate)) {
                const msg = 'End date must be after start date';
                if (typeof window.showToast === 'function') {
                    window.showToast(msg, 'error');
                } else {
                    alert(msg);
                }
                endDateInput.focus();
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
                return;
            }
        }
        
        // Prepare project data - only send fields that exist in the model
        const projectData = {
            name: projectName,
            description: descriptionInput.value.trim() || ''
        };
        
        // Only add dates if they exist in the model (check if fields exist)
        // For now, we'll only send name and description since they're guaranteed to exist
        // If you add start_date and end_date to the model, uncomment these:
        // if (startDate) projectData.start_date = startDate;
        // if (endDate) projectData.end_date = endDate;
        
        try {
            // Check if API is available
            if (typeof window.API === 'undefined' || !window.API.projects) {
                throw new Error('API not loaded. Please refresh the page.');
            }
            
            if (projectId) {
                await window.API.projects.update(projectId, projectData);
                if (typeof window.showToast === 'function') {
                    window.showToast('Project updated successfully!', 'success');
                } else {
                    alert('Project updated successfully!');
                }
            } else {
                await window.API.projects.create(projectData);
                if (typeof window.showToast === 'function') {
                    window.showToast('Project created successfully!', 'success');
                } else {
                    alert('Project created successfully!');
                }
            }
            
            closeProjectModal();
            await loadProjects();
        } catch (error) {
            console.error('Error saving project:', error);
            let errorMessage = 'Failed to save project. Please try again.';
            
            if (error.response && error.response.data) {
                const errorData = error.response.data;
                if (typeof errorData === 'object') {
                    const errorList = Object.entries(errorData).map(([key, value]) => {
                        if (Array.isArray(value)) {
                            return `${key}: ${value.join(', ')}`;
                        }
                        return `${key}: ${value}`;
                    }).join('\n');
                    errorMessage = errorList || errorMessage;
                } else {
                    errorMessage = String(errorData);
                }
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            if (typeof window.showToast === 'function') {
                window.showToast(errorMessage, 'error');
            } else {
                alert(errorMessage);
            }
        } finally {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
    }

    function openDeleteModal(projectId) {
        projectToDelete = projectId;
        document.getElementById('delete-modal').classList.add('active');
    }

    function closeDeleteModal() {
        projectToDelete = null;
        document.getElementById('delete-modal').classList.remove('active');
    }

    async function confirmDelete() {
        if (!projectToDelete) return;
        
        try {
            // Check if API is available
            if (typeof window.API === 'undefined' || !window.API.projects) {
                throw new Error('API not loaded. Please refresh the page.');
            }
            
            await window.API.projects.delete(projectToDelete);
            if (typeof window.showToast === 'function') {
                window.showToast('Project deleted successfully!', 'success');
            } else {
                alert('Project deleted successfully!');
            }
            closeDeleteModal();
            await loadProjects();
        } catch (error) {
            console.error('Error deleting project:', error);
            const errorMessage = error.message || 'Failed to delete project. Please try again.';
            if (typeof window.showToast === 'function') {
                window.showToast(errorMessage, 'error');
            } else {
                alert(errorMessage);
            }
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } catch (e) {
            return 'N/A';
        }
    }

    function escapeHtml(text) {
        if (text === null || typeof text === 'undefined') return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    // Use showToast from main.js - no local definition to avoid recursion

    // Make functions globally available
    window.openAddProjectModal = openAddProjectModal;
    window.openEditProjectModal = openEditProjectModal;
    window.openDeleteModal = openDeleteModal;
    window.confirmDelete = confirmDelete;
    window.openProject = openProject;
    window.loadProjects = loadProjects;
</script>
{% endblock %}