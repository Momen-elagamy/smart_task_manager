{% extends 'base.html' %}

{% block title %}Analytics - S T manger{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
{% endblock %}

{% block main_content %}
<header class="page-header">
    <div class="header-left">
        <h1>Analytics Dashboard</h1>
        <p>Overview of your projects, tasks, and team performance</p>
    </div>
    <div class="header-right">
        <button class="icon-button" id="refresh-btn" title="Refresh Analytics">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        </button>
        <button class="icon-button" id="export-btn" title="Export Analytics">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        </button>
        <button class="primary-button" onclick="window.location.href='/chat/'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            AI Insights
        </button>
    </div>
</header>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-pink));">
            <i class="fas fa-tasks" style="color:white; font-size:24px;"></i>
        </div>
        <div class="stat-info">
            <h3 id="total-tasks">0</h3>
            <p>Total Tasks</p>
            <div class="stat-change change-positive">
                <i class="fas fa-arrow-up"></i>
                <span id="total-tasks-change">Loading...</span>
            </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));">
            <i class="fas fa-project-diagram" style="color:white; font-size:24px;"></i>
        </div>
        <div class="stat-info">
            <h3 id="total-projects">0</h3>
            <p>Total Projects</p>
            <div class="stat-change change-positive">
                <i class="fas fa-arrow-up"></i>
                <span id="total-projects-change">Loading...</span>
            </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));">
            <i class="fas fa-users" style="color:white; font-size:24px;"></i>
        </div>
        <div class="stat-info">
            <h3 id="active-members">0</h3>
            <p>Active Members</p>
            <div class="stat-change change-positive">
                <i class="fas fa-arrow-up"></i>
                <span id="active-members-change">Loading...</span>
            </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));">
            <i class="fas fa-chart-pie" style="color:white; font-size:24px;"></i>
        </div>
        <div class="stat-info">
            <h3 id="completion-rate">0%</h3>
            <p>Avg Completion</p>
            <div class="stat-change change-positive">
                <i class="fas fa-arrow-up"></i>
                <span id="completion-rate-change">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Filter Tabs -->
<div class="filter-tabs">
    <button class="tab active" data-period="7days">Last 7 Days</button>
    <button class="tab" data-period="30days">Last 30 Days</button>
    <button class="tab" data-period="90days">Last 90 Days</button>
    <button class="tab" data-period="year">This Year</button>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h3>Tasks by Status</h3>
            <div class="chart-actions">
                <button class="btn-secondary" onclick="changeChartView('tasks', 'doughnut', event)">Doughnut</button>
                <button class="btn-primary" onclick="changeChartView('tasks', 'pie', event)">Pie</button>
            </div>
        </div>
        <canvas id="tasks-status-chart" height="200"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-header">
            <h3>Project Progress</h3>
            <div class="chart-actions">
                <button class="btn-secondary" onclick="changeChartView('progress', 'bar', event)">Bar</button>
                <button class="btn-primary" onclick="changeChartView('progress', 'line', event)">Line</button>
            </div>
        </div>
        <canvas id="project-progress-chart" height="200"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-header">
            <h3>Task Trends</h3>
            <div class="chart-actions">
                <button class="btn-primary" onclick="refreshChart('trends')">Refresh</button>
            </div>
        </div>
        <canvas id="task-trends-chart" height="200"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-header">
            <h3>Team Performance</h3>
            <div class="chart-actions">
                <button class="btn-secondary" onclick="changeViewMode('department', event)">Department</button>
                <button class="btn-primary" onclick="changeViewMode('individual', event)">Individual</button>
            </div>
        </div>
        <canvas id="team-performance-chart" height="200"></canvas>
    </div>
</div>

<!-- Recent Activity Section -->
<div class="activity-section">
    <h3>Recent Activity</h3>
    <div class="activity-list" id="activity-list">
        <div class="activity-item">
            <div class="activity-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="activity-content">
                <p>Loading recent activity...</p>
                <span class="activity-time"></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<style>
/* =========================
   Shared layout & dark mode
========================= */
.stats-grid, .charts-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 32px;
}
.stats-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
.charts-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

.chart-card, .activity-section, .stat-card {
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(15px);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.15);
    padding: 24px;
    transition: all 0.3s ease;
}
.chart-card:hover, .activity-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(6, 182, 212, 0.2);
    border-color: var(--accent-cyan);
}

/* Page header */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}
.header-right { display: flex; gap: 0.75rem; align-items: center; }

/* Buttons */
.icon-button, .primary-button, .btn-primary, .btn-secondary {
    transition: all 0.3s ease;
    cursor: pointer;
}
.icon-button { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius:10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); }
.primary-button { padding: 0.75rem 1.5rem; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); color: white; border-radius:12px; display:flex; align-items:center; gap:0.5rem; font-weight:600; }
.btn-primary { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); color:white; border-radius:10px; padding:0.5rem 1rem; font-weight:600; border:none; }
.btn-secondary { background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.2); color: var(--text-secondary); border-radius:10px; padding:0.5rem 1rem; font-weight:500; }

/* Tabs */
.filter-tabs { display:flex; gap:8px; margin-bottom:24px; overflow-x:auto; padding-bottom:8px; }
.tab { padding:10px 20px; background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:10px; color: var(--text-secondary); font-weight:500; cursor:pointer; }
.tab.active { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); color:white; border-color:transparent; }

/* Activity Section */
.activity-section h3 { font-size:1.25rem; font-weight:600; color:var(--text-primary); margin-bottom:1.5rem; }
.activity-list { display:flex; flex-direction:column; gap:1rem; }
.activity-item { display:flex; align-items:flex-start; gap:1rem; padding:1rem; border-radius:12px; background: rgba(255,255,255,0.03); transition: all 0.3s ease; }
.activity-icon { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; background: rgba(6,182,212,0.1); color:var(--accent-cyan); flex-shrink:0; }
.activity-content p { margin-bottom:0.25rem; color:var(--text-primary); }
.activity-time { font-size:0.75rem; color:var(--text-muted); }

/* Toast */
.toast { position: fixed; top:24px; right:24px; padding:16px 24px; color:white; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.3); z-index:10000; font-weight:500; animation: slideInRight 0.3s ease; backdrop-filter:blur(10px); max-width:300px; }
.toast-close { float:right; cursor:pointer; margin-left:10px; font-weight:bold; }
@keyframes slideInRight { from{opacity:0; transform:translateX(100px);} to{opacity:1; transform:translateX(0);} }
@keyframes slideOutRight { from{opacity:1; transform:translateX(0);} to{opacity:0; transform:translateX(100px);} }

@media (max-width:768px){
    .page-header { flex-direction:column; gap:1rem; align-items:flex-start; }
    .header-right { width:100%; justify-content:space-between; }
    .stats-grid { grid-template-columns:repeat(2,1fr); gap:16px; }
    .chart-header { flex-direction:column; align-items:flex-start; gap:1rem; }
    .chart-actions { width:100%; justify-content:flex-end; }
}
@media (max-width:480px){
    .stats-grid { grid-template-columns:1fr !important; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// =========================
// Charts Initialization
// =========================
let tasksChart, progressChart, trendsChart, performanceChart;

document.addEventListener('DOMContentLoaded', async function() {
    initCharts();
    await loadAnalytics();
    await loadRecentActivity();
    document.getElementById('refresh-btn').addEventListener('click', async () => { 
        await loadAnalytics(); 
        await loadRecentActivity();
        showToast('Analytics refreshed','success'); 
    });
    document.getElementById('export-btn').addEventListener('click', exportAnalytics);

    document.querySelectorAll('.filter-tabs .tab').forEach(tab=>{
        tab.addEventListener('click',async function(){
            document.querySelectorAll('.filter-tabs .tab').forEach(t=>t.classList.remove('active'));
            this.classList.add('active');
            await loadAnalytics(this.dataset.period);
            showToast(`Showing data for: ${this.textContent}`,'info');
        });
    });
});

function initCharts(){
    // Tasks Status
    tasksChart = new Chart(document.getElementById('tasks-status-chart').getContext('2d'),{
        type:'doughnut',
        data:{ labels:['Done','In Progress','To Do'], datasets:[{ data:[0,0,0], backgroundColor:['#06b6d4','#a78bfa','#f472b6'], borderWidth:0 }] },
        options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#ffffff' }, position:'bottom' } } }
    });

    // Project Progress
    progressChart = new Chart(document.getElementById('project-progress-chart').getContext('2d'),{
        type:'bar',
        data:{ labels:[], datasets:[{ label:'Completion %', data:[], backgroundColor:'#f97316', borderRadius:8 }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:value=>value+'%' , color:'#ffffff' } }, x:{ ticks:{ color:'#ffffff' } } } }
    });

    // Task Trends
    trendsChart = new Chart(document.getElementById('task-trends-chart').getContext('2d'),{
        type:'line',
        data:{ labels:[], datasets:[{ label:'Tasks Completed', data:[], borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.1)', tension:0.3, fill:true }] },
        options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#ffffff' }, position:'bottom' } } }
    });

    // Team Performance
    performanceChart = new Chart(document.getElementById('team-performance-chart').getContext('2d'),{
        type:'radar',
        data:{ labels:['Productivity','Quality','Collaboration','Creativity','Timeliness'], datasets:[{ label:'Team Performance', data:[0,0,0,0,0], backgroundColor:'rgba(139,92,246,0.2)', borderColor:'#8b5cf6', pointBackgroundColor:'#8b5cf6', pointBorderColor:'#fff', pointHoverBackgroundColor:'#fff', pointHoverBorderColor:'#8b5cf6' }] },
        options:{ responsive:true, scales:{ r:{ pointLabels:{ color:'#ffffff' }, grid:{ color:'rgba(255,255,255,0.2)' }, angleLines:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#ffffff' } } } }
    });
}

async function loadAnalytics(period='30days'){
    // Fetch data
    const [stats, projectsRaw, tasksRaw] = await Promise.all([
        window.API.stats.getStats().catch(()=>({total_tasks:0,pending_tasks:0,in_progress_tasks:0,completed_tasks:0})),
        window.API.projects.getAll().catch(()=>[]),
        window.API.tasks.getAll().catch(()=>[])
    ]);

    const tasks = Array.isArray(tasksRaw) ? tasksRaw : (tasksRaw.results || []);
    const projects = Array.isArray(projectsRaw) ? projectsRaw : (projectsRaw.results || []);

    // Update stat cards
    const total = stats.total_tasks || tasks.length || 0;
    const completed = stats.completed_tasks || tasks.filter(t=>t.status==='done' || t.status==='completed').length;
    const inProgress = stats.in_progress_tasks || tasks.filter(t=>t.status==='in_progress').length;
    const pending = stats.pending_tasks || tasks.filter(t=>t.status==='todo' || t.status==='pending').length;

    setAnimatedValue('total-tasks', total, false);
    setAnimatedValue('total-projects', projects.length || 0, false);
    // Active members approximated by unique assignees in tasks
    const uniqueAssignees = new Set(
        tasks
          .map(t=> {
              const a = t.assigned_to;
              if (!a) return null;
              return (typeof a === 'object' && a !== null) ? (a.id || a.pk || a.email || a.username) : a;
          })
          .filter(Boolean)
    );
    setAnimatedValue('active-members', uniqueAssignees.size, false);
    const completionRate = total ? Math.round((completed/total)*100) : 0;
    setAnimatedValue('completion-rate', completionRate, true);

    // Update Tasks by Status chart
    tasksChart.data.labels = ['Done','In Progress','To Do'];
    tasksChart.data.datasets[0].data = [completed, inProgress, pending];
    tasksChart.update();

    // Project progress chart: completion % per project
    const projectTaskMap = new Map();
    tasks.forEach(t=>{
        const projectField = t.project;
        const pid = (projectField && typeof projectField === 'object') ? (projectField.id || projectField.pk) : projectField;
        if(!pid) return;
        if(!projectTaskMap.has(pid)) projectTaskMap.set(pid,{total:0,done:0});
        const entry = projectTaskMap.get(pid);
        entry.total += 1;
        if(t.status==='done' || t.status==='completed') entry.done += 1;
    });
    const progressLabels = [];
    const progressValues = [];
    projects.forEach(p=>{
        const entry = projectTaskMap.get(p.id) || {total:0,done:0};
        const pct = entry.total ? Math.round((entry.done/entry.total)*100) : 0;
        progressLabels.push(p.name || `Project ${p.id}`);
        progressValues.push(pct);
    });
    progressChart.data.labels = progressLabels.slice(0, 12);
    progressChart.data.datasets[0].data = progressValues.slice(0, 12);
    progressChart.update();

    // Task trends: last 6 months completed
    const byMonth = new Map();
    const now = new Date();
    for(let i=5;i>=0;i--){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        byMonth.set(key,0);
    }
    tasks.filter(t=>t.status==='done' || t.status==='completed').forEach(t=>{
        const created = t.created_at ? new Date(t.created_at) : (t.updated_at ? new Date(t.updated_at) : null);
        if(!created) return;
        const key = `${created.getFullYear()}-${String(created.getMonth()+1).padStart(2,'0')}`;
        if(byMonth.has(key)) byMonth.set(key, byMonth.get(key)+1);
    });
    const labels = Array.from(byMonth.keys()).map(k=>{
        const [y,m] = k.split('-');
        return new Date(Number(y), Number(m)-1, 1).toLocaleString(undefined,{month:'short'});
    });
    const values = Array.from(byMonth.values());
    trendsChart.data.labels = labels;
    trendsChart.data.datasets[0].data = values;
    trendsChart.update();

    // Team performance (placeholder derived metrics)
    performanceChart.data.datasets[0].data = [completionRate, 70, 80, 65, 75];
    performanceChart.update();
}

function setAnimatedValue(id, end, isPercent){
    const el = document.getElementById(id);
    if(!el) return;
    const start = 0;
    const duration = 500;
    const startTime = performance.now();
    function step(now){
        const t = Math.min(1, (now - startTime)/duration);
        const val = Math.round(start + (end - start) * t);
        el.textContent = isPercent ? `${val}%` : `${val}`;
        if(t < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

async function loadRecentActivity() {
    const activityList = document.getElementById('activity-list');
    if (!activityList) return;
    
    try {
        const response = await window.API.stats.getRecentActivity();
        const activities = response.results || [];
        
        if (activities.length === 0) {
            activityList.innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="activity-content">
                        <p>No recent activity</p>
                        <span class="activity-time"></span>
                    </div>
                </div>
            `;
            return;
        }
        
        activityList.innerHTML = '';
        activities.forEach(activity => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            
            const icon = document.createElement('div');
            icon.className = 'activity-icon';
            icon.innerHTML = `<i class="fas fa-${activity.icon}"></i>`;
            
            const content = document.createElement('div');
            content.className = 'activity-content';
            content.innerHTML = `
                <p>${activity.description}</p>
                <span class="activity-time">${activity.time_ago}</span>
            `;
            
            item.appendChild(icon);
            item.appendChild(content);
            activityList.appendChild(item);
        });
    } catch (error) {
        console.error('Failed to load recent activity:', error);
        activityList.innerHTML = `
            <div class="activity-item">
                <div class="activity-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="activity-content">
                    <p>Failed to load activity</p>
                    <span class="activity-time"></span>
                </div>
            </div>
        `;
    }
}

function refreshAnalytics(){ /* handled in loadAnalytics binding */ }
function exportAnalytics(){ showToast('Export started','success'); }
function updateChartsForPeriod(period){ /* handled inside loadAnalytics(period) */ }
function changeChartView(chart, type, e){ showToast(`Changed ${chart} chart to ${type}`,'info'); }
function changeViewMode(mode, e){ showToast(`Viewing ${mode} mode`,'info'); }

// =========================
// Toast notifications
// =========================
function showToast(message,type='info'){
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.background = type==='success' ? 'linear-gradient(135deg,#06b6d4,#8b5cf6)' : type==='error' ? '#f87171' : 'rgba(255,255,255,0.15)';
    toast.innerHTML = message + `<span class="toast-close" onclick="this.parentElement.remove()">Ã—</span>`;
    document.body.appendChild(toast);
    setTimeout(()=>{ toast.style.animation='slideOutRight 0.3s ease'; setTimeout(()=>toast.remove(),300); },3000);
}
</script>
{% endblock %}
