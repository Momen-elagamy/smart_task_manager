{% extends 'base.html' %}
{% load static %}

{% block title %}Profile - Smart Task Manager{% endblock %}

{% block extra_css %}
<style>
    .profile-hero { margin-bottom: 22px; padding: 20px 22px; border-radius: 20px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(6,182,212,0.12)); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 20px 60px rgba(0,0,0,0.28); display: flex; align-items: center; justify-content: space-between; gap: 14px; }
    .profile-hero h1 { margin: 0; font-size: 26px; font-weight: 800; }
    .profile-hero p { margin: 4px 0 0; color: rgba(255,255,255,0.7); }
    .profile-grid { display: grid; grid-template-columns: 360px 1fr; gap: 20px; align-items: start; }
    .glass-card { position: relative; border-radius: 18px; padding: 24px; background: linear-gradient(150deg, rgba(255,255,255,0.07), rgba(255,255,255,0.025)); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 24px 64px rgba(0,0,0,0.3); overflow: hidden; }
    .profile-summary { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; padding: 18px 18px 22px; }
    .avatar-wrapper { display: grid; place-items: center; width: 100%; }
    .avatar-circle { position: relative; width: 148px; height: 148px; border-radius: 50%; background: linear-gradient(135deg,var(--primary),var(--glow)); background-size: cover; background-position: center; background-repeat: no-repeat; display: grid; place-items: center; color: #fff; font-size: 56px; font-weight: 800; box-shadow: 0 14px 36px rgba(0,0,0,0.32); margin: 0; overflow: hidden; }
    .avatar-circle.has-image span { display: none; }
    .avatar-upload { margin-top: 8px; display: inline-flex; align-items: center; gap: 8px; font-size: 12px; padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.16); color: #e5e7eb; box-shadow: 0 10px 26px rgba(0,0,0,0.25); cursor: pointer; }
    .avatar-remove { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: rgba(255,255,255,0.7); border: none; background: transparent; padding: 6px 8px; cursor: pointer; }
    .glass-card h3 { margin: 0 0 14px; display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 800; }
    .card-meta { margin: 0 0 12px; color: rgba(255,255,255,0.65); font-size: 13px; }
    .avatar-circle { width: 148px; height: 148px; border-radius: 50%; background: linear-gradient(135deg,var(--primary),var(--glow)); display: grid; place-items: center; color: #fff; font-size: 56px; font-weight: 800; box-shadow: 0 14px 36px rgba(0,0,0,0.32); margin: 0 0 18px; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 14px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.14); font-size: 12px; font-weight: 750; color: rgba(255,255,255,0.9); }
    .stats { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; text-align: center; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 18px; }
    .stat-val { font-size: 26px; font-weight: 850; }
    .stat-label { font-size: 12px; letter-spacing: 0.01em; color: rgba(255,255,255,0.7); }
    .field-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 14px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-weight: 700; font-size: 13px; color: #e5e7eb; }
    .form-input, .form-textarea { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); color: #e5e7eb; border-radius: 12px; padding: 12px 14px; font-weight: 600; box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 10px 30px rgba(0,0,0,0.18); transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease; }
    .form-input::placeholder, .form-textarea::placeholder { color: rgba(255,255,255,0.55); }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: rgba(99,102,241,0.6); box-shadow: 0 0 0 4px rgba(99,102,241,0.18), 0 12px 32px rgba(0,0,0,0.22); transform: translateY(-1px); }
    .btn { border-radius: 12px; padding: 12px 16px; font-weight: 800; letter-spacing: 0.01em; border: 1px solid rgba(255,255,255,0.12); background: linear-gradient(135deg, rgba(99,102,241,0.9), rgba(6,182,212,0.9)); color: #fff; box-shadow: 0 12px 28px rgba(6,182,212,0.25); transition: transform 0.12s ease, box-shadow 0.2s ease, filter 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 14px 30px rgba(6,182,212,0.32); filter: saturate(1.05); }
    .btn:active { transform: translateY(0); box-shadow: 0 10px 24px rgba(6,182,212,0.25); }
    .btn-secondary { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.16); color: #e5e7eb; box-shadow: 0 10px 26px rgba(0,0,0,0.25); }
    .badge { padding: 6px 12px; border-radius: 999px; font-weight: 700; font-size: 11px; }
    .status-badge { display:none; padding:10px 12px; border-radius:12px; font-weight:700; font-size:13px; }
    .status-success { display:none; background:rgba(34,197,94,0.12); color:#34d399; border:1px solid rgba(52,211,153,0.5); }
    .status-error { display:none; background:rgba(248,113,113,0.12); color:#f87171; border:1px solid rgba(248,113,113,0.45); }
    @media(max-width: 960px){ .profile-grid { grid-template-columns: 1fr; } .glass-card { padding: 22px; } }
    @media(max-width: 640px){ .profile-hero { flex-direction: column; align-items: flex-start; } }
</style>
{% endblock %}

{% block content %}
<section class="profile-hero">
    <div>
        <h1>Profile</h1>
        <p>Manage your personal info and recent activity.</p>
    </div>
    <div class="actions">
        <a href="{% url 'settings' %}" class="btn btn-secondary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
            </svg>
            Settings
        </a>
    </div>
</section>

<div class="profile-grid">
    <div class="glass-card">
        <div class="profile-summary">
            <div class="avatar-wrapper">
                <div class="avatar-circle" id="avatar-circle" data-avatar-target="user"><span id="avatar-initial" data-avatar-initial>{{ request.user.first_name.0|default:"U" }}</span></div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center;">
                <label class="avatar-upload" for="avatar-input">Upload photo</label>
                <button type="button" class="avatar-remove" id="avatar-remove">Remove</button>
            </div>
            <input type="file" id="avatar-input" accept="image/*" style="display:none;">
            <h2 style="margin:0;font-size:22px;font-weight:800;" id="profile-name">{% if request.user.get_full_name %}{{ request.user.get_full_name }}{% else %}{{ request.user.email }}{% endif %}</h2>
            <p style="margin:0;color:var(--text-muted);font-size:13px;" id="profile-email">{{ request.user.email }}</p>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:4px 0 4px;">
                <span class="pill">Role: Admin</span>
                <span class="pill">Status: Active</span>
            </div>
            <div class="stats" style="width:100%;">
                <div>
                    <div class="stat-val" style="color: var(--primary);" id="profile-tasks">0</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div>
                    <div class="stat-val" style="color: var(--accent);" id="profile-projects">0</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div>
                    <div class="stat-val" style="color: var(--glow);" id="profile-completed">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            Account info
        </h3>
        <p class="card-meta">Keep your profile up to date.</p>
        <div id="profile-success" class="status-badge status-success"></div>
        <div id="profile-error" class="status-badge status-error"></div>
        <form id="profile-form" class="stack">
            {% csrf_token %}
            <div class="field-grid">
                <div class="field">
                    <label>First name</label>
                    <input type="text" name="first_name" class="form-input" value="{{ request.user.first_name }}" placeholder="First name">
                </div>
                <div class="field">
                    <label>Last name</label>
                    <input type="text" name="last_name" class="form-input" value="{{ request.user.last_name }}" placeholder="Last name">
                </div>
            </div>
            <div class="field">
                <label>Email</label>
                <input type="email" name="email" class="form-input" value="{{ request.user.email }}" readonly style="opacity:0.7;cursor:not-allowed;">
                <small style="color:var(--text-muted);font-size:11px;">Email cannot be changed</small>
            </div>
            <div class="field">
                <label>Phone</label>
                <input type="tel" name="phone" class="form-input" placeholder="+1 xxx xxx xxxx">
            </div>
            <div class="field">
                <label>Bio</label>
                <textarea name="bio" class="form-textarea" rows="3" placeholder="Write a short bio..."></textarea>
            </div>
            <div class="actions" style="justify-content:flex-end;">
                <button type="button" class="btn btn-secondary" onclick="window.location.reload()">Cancel</button>
                <button type="submit" class="btn" id="save-profile-btn">Save changes</button>
            </div>
        </form>
    </div>
</div>

<div class="glass-card" style="margin-top:18px;">
    <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
        Recent activity
    </h3>
    <p class="card-meta">Latest tasks you touched.</p>
    <div id="activity-list" style="display:flex;flex-direction:column;gap:12px;">
        <div style="text-align:center;padding:32px;color:var(--text-muted);">Loading activity...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadProfileStats();
    loadRecentActivity();
    
    const avatarCircle = document.getElementById('avatar-circle');
    const avatarInput = document.getElementById('avatar-input');
    const avatarInitial = document.getElementById('avatar-initial');
    const avatarRemove = document.getElementById('avatar-remove');

    const savedAvatar = localStorage.getItem('profileAvatarData');
    if (savedAvatar) {
        applyAvatar(savedAvatar, avatarCircle, avatarInitial);
    }

    avatarInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            applyAvatar(ev.target.result, avatarCircle, avatarInitial);
            localStorage.setItem('profileAvatarData', ev.target.result);
        };
        reader.readAsDataURL(file);
    });

    avatarRemove.addEventListener('click', () => {
        clearAvatar(avatarCircle, avatarInitial);
        localStorage.removeItem('profileAvatarData');
    });

    const form = document.getElementById('profile-form');
    const successBox = document.getElementById('profile-success');
    const errorBox = document.getElementById('profile-error');
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        successBox.style.display = 'none';
        errorBox.style.display = 'none';
        
        const btn = document.getElementById('save-profile-btn');
        btn.disabled = true;
        btn.textContent = 'جارٍ الحفظ...';
        
        const formData = new FormData(form);
        const data = {
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            phone: formData.get('phone'),
            bio: formData.get('bio')
        };
        
        try {
            const token = localStorage.getItem('accessToken');
            const res = await fetch('/api/users/profile/', {
                method: 'PATCH',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? 'Bearer ' + token : '',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                successBox.textContent = 'تم حفظ التغييرات بنجاح';
                successBox.style.display = 'block';
                
                // تحديث الاسم في الصفحة
                const fullName = (data.first_name + ' ' + data.last_name).trim();
                if (fullName) {
                    document.getElementById('profile-name').textContent = fullName;
                }
            } else {
                errorBox.textContent = 'فشل في حفظ التغييرات';
                errorBox.style.display = 'block';
            }
        } catch (err) {
            errorBox.textContent = 'خطأ في الاتصال';
            errorBox.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = 'حفظ التغييرات';
        }
    });
});

async function loadProfileStats() {
    try {
        const token = localStorage.getItem('accessToken');
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        
        const [tasksRes, projectsRes] = await Promise.all([
            fetch('/api/tasks/', { credentials: 'include', headers }),
            fetch('/api/projects/', { credentials: 'include', headers })
        ]);
        
        if (tasksRes.ok) {
            const data = await tasksRes.json();
            const tasks = data.results || data;
            document.getElementById('profile-tasks').textContent = tasks.length;
            document.getElementById('profile-completed').textContent = tasks.filter(t => t.status === 'done').length;
        }
        
        if (projectsRes.ok) {
            const data = await projectsRes.json();
            const projects = data.results || data;
            document.getElementById('profile-projects').textContent = projects.length;
        }
    } catch (err) {
        console.error('Error loading stats:', err);
    }
}

function applyAvatar(dataUrl, avatarCircle, avatarInitial) {
    if (!avatarCircle || !dataUrl) return;
    avatarCircle.style.backgroundImage = `url('${dataUrl}')`;
    avatarCircle.classList.add('has-image');
    if (avatarInitial) {
        avatarInitial.style.display = 'none';
    }
}

function clearAvatar(avatarCircle, avatarInitial) {
    if (!avatarCircle) return;
    avatarCircle.style.backgroundImage = '';
    avatarCircle.classList.remove('has-image');
    if (avatarInitial) {
        avatarInitial.style.display = 'block';
    }
}

async function loadRecentActivity() {
    const container = document.getElementById('activity-list');
    
    try {
        const token = localStorage.getItem('accessToken');
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        
        const res = await fetch('/api/tasks/?ordering=-created_at', { credentials: 'include', headers });
        
        if (res.ok) {
            const data = await res.json();
            const tasks = (data.results || data).slice(0, 5);
            
            if (tasks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No activity yet</div>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div style="display:flex;align-items:center;gap:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:12px;border:1px solid rgba(255,255,255,0.08);">
                    <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--glow));display:flex;align-items:center;justify-content:center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;margin-bottom:4px;">${task.title}</div>
                        <div style="font-size:12px;color:var(--text-muted);">
                                ${task.status === 'done' ? 'Completed' : task.status === 'in_progress' ? 'In progress' : 'Pending'}
                            • ${task.created_at ? new Date(task.created_at).toLocaleDateString('ar-EG') : ''}
                        </div>
                    </div>
                    <span class="badge badge-${task.status === 'done' ? 'success' : task.status === 'in_progress' ? 'warning' : 'secondary'}" style="padding:6px 12px;border-radius:20px;font-size:11px;">
                            ${task.priority === 'high' ? 'High' : task.priority === 'medium' ? 'Medium' : 'Low'}
                    </span>
                </div>
            `).join('');
        }
    } catch (err) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">خطأ في تحميل النشاط</div>';
    }
}
</script>
{% endblock %}
