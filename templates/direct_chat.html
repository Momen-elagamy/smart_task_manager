{% extends 'base.html' %}
{% load static %}

{% block title %}Direct Messages - {{ block.super }}{% endblock %}

{% block extra_head %}
    <style>
        .dm-container { display: flex; flex-direction: column; height: calc(100vh - 120px); }
        .dm-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,0.08); }
        .dm-title { font-weight:700; font-size:18px; }
        .dm-messages { flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
        .dm-input { display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,0.08); }
        .dm-input textarea { flex:1; min-height:44px; max-height:160px; border-radius:12px; padding:12px 14px; resize:vertical; }
        .dm-message { background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08); padding:10px 12px; border-radius:12px; max-width:70%; }
        .dm-message.me { align-self:flex-end; background: rgba(6, 182, 212, 0.15); border-color: rgba(6, 182, 212, 0.35); }
        .dm-meta { font-size:11px; color: var(--text-muted); margin-top:6px; }
        .dm-empty { text-align:center; opacity:0.7; padding:24px; }
        .dm-send { padding: 0 16px; border-radius:10px; }
    </style>
{% endblock %}

{% block main_content %}
<div class="dm-container" data-room-id="{{ room_id }}">
    <div class="dm-header">
        <div class="dm-title">Direct Messages</div>
        <a href="{% url 'team' %}" class="btn-small">Back to Team</a>
    </div>
    <div id="dm-messages" class="dm-messages">
        <div class="dm-empty" id="dm-empty">No messages yet. Say hello!</div>
    </div>
    <div class="dm-input">
        <textarea id="dm-text" class="form-input" placeholder="Write a message..."></textarea>
        <button id="dm-send" class="btn btn-primary dm-send">Send</button>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
{{ block.super }}
<script>
(function(){
  const roomId = document.querySelector('.dm-container').dataset.roomId;
  const messagesEl = document.getElementById('dm-messages');
  const emptyEl = document.getElementById('dm-empty');
  const textEl = document.getElementById('dm-text');
  const sendBtn = document.getElementById('dm-send');

  function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
  function appendMessage(msg){
    emptyEl.style.display='none';
    const wrap = el('div', 'dm-message' + (msg.sender_email && window.CURRENT_USER_EMAIL && msg.sender_email===window.CURRENT_USER_EMAIL ? ' me' : ''));
    wrap.innerHTML = `
      <div>${escapeHtml(msg.content || '')}</div>
      <div class="dm-meta">${escapeHtml(msg.sender_name || msg.sender_email || '')}</div>
    `;
    messagesEl.appendChild(wrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function escapeHtml(t){ if(!t) return ''; const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

  async function loadMessages(){
    try{
      const resp = await window.API.chat.getMessages(roomId);
      messagesEl.innerHTML='';
      if(Array.isArray(resp) && resp.length){
        // API returns newest first; display oldest first
        resp.slice().reverse().forEach(m => appendMessage(m));
      } else {
        emptyEl.style.display='block';
      }
    }catch(e){ console.error('Load DM failed', e); }
  }

  async function send(){
    const content = (textEl.value||'').trim();
    if(!content) return;
    try{
      const msg = await window.API.chat.sendMessage(roomId, content);
      textEl.value='';
      appendMessage(msg);
    }catch(e){ console.error('Send DM failed', e); alert(e?.message||'Failed to send'); }
  }

  sendBtn.addEventListener('click', send);
  textEl.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter' && !ev.shiftKey){ ev.preventDefault(); send(); }});

  // Optional: get current user email for 'me' styling, via profile
  (async()=>{
    try{
      const prof = await window.API.users.getProfile();
      window.CURRENT_USER_EMAIL = prof?.email;
    }catch(_){ /* ignore */ }
  })();

  loadMessages();
})();
</script>
{% endblock %}
