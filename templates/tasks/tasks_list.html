{% extends 'base.html' %}
{% block title %}Ø§Ù„Ù…Ù‡Ø§Ù… | Smart Task Manager{% endblock %}

{% block content %}
<header class="page-header slide-up">
  <div class="header-content">
    <div>
      <h1 class="header-title">Ø§Ù„Ù…Ù‡Ø§Ù…</h1>
      <p class="header-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ù…Ù‡Ø§Ù…Ùƒ</p>
    </div>
    <div class="header-actions gap-md">
      <input type="text" id="task-search" class="form-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‡Ù…Ø©..." style="width:220px" />
      <select id="filter-status" class="form-select" style="width:150px">
        <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="todo">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
        <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
        <option value="done">Ù…ÙƒØªÙ…Ù„Ø©</option>
      </select>
      <button class="btn btn-primary" id="new-task-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
      </button>
    </div>
  </div>
</header>

<style>
.task-card.completed {
    opacity: 0.8;
    border-color: rgba(76, 175, 80, 0.3);
}
.task-status-toggle {
    margin-right: auto;
}
.task-footer {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
}
.btn-success {
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
    border: 1px solid rgba(76, 175, 80, 0.3);
}
.btn-success:hover {
    background: rgba(76, 175, 80, 0.3);
}
.badge-success {
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
}
.badge-warning {
    background: rgba(255, 193, 7, 0.2);
    color: #FFC107;
}
.badge-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-muted);
}
</style>

<div id="tasks-grid" class="tasks-grid fade-in" style="margin-top:1rem">
  <div style="text-align:center;padding:40px;color:var(--text-muted);">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>
{% endblock %}

{% block modals %}
<!-- New Task Modal -->
<div class="modal" id="new-task-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <button class="modal-close" onclick="closeModal('new-task-modal')">Ã—</button>
        </div>
        
        <form id="new-task-form">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© *</label>
                <input type="text" name="title" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                <textarea name="description" class="form-textarea" rows="4" placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ù‡Ù…Ø©"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ *</label>
                <select name="project" class="form-select" id="project-select" required>
                    <option value="">Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© *</label>
                <select name="priority" class="form-select" required>
                    <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                    <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
                    <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                <select name="status" class="form-select" required>
                    <option value="todo" selected>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                    <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                    <option value="done">Ù…ÙƒØªÙ…Ù„</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                <input type="date" name="due_date" class="form-input">
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('new-task-modal')">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="submit" class="btn btn-primary">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Task Modal - Modern Glass UI -->
<div class="edit-modal-overlay" id="edit-task-modal">
    <div class="edit-modal-container">
        <!-- Decorative Elements -->
        <div class="edit-modal-glow"></div>
        <div class="edit-modal-particles">
            <span></span><span></span><span></span><span></span><span></span>
        </div>
        
        <div class="edit-modal-card">
            <!-- Header with Icon -->
            <div class="edit-modal-header">
                <div class="edit-modal-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </div>
                <div class="edit-modal-title-section">
                    <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</h2>
                    <p>Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</p>
                </div>
                <button class="edit-modal-close" onclick="closeEditModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Form Body -->
            <form id="edit-task-form" class="edit-modal-form">
                {% csrf_token %}
                <input type="hidden" name="task_id" id="edit-task-id">
                
                <!-- Title Input -->
                <div class="edit-form-group">
                    <label class="edit-form-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        </svg>
                        Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©
                    </label>
                    <input type="text" name="title" id="edit-task-title" class="edit-form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©" required>
                </div>
                
                <!-- Description -->
                <div class="edit-form-group">
                    <label class="edit-form-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <line x1="17" y1="10" x2="3" y2="10"></line>
                            <line x1="21" y1="6" x2="3" y2="6"></line>
                            <line x1="21" y1="14" x2="3" y2="14"></line>
                            <line x1="17" y1="18" x2="3" y2="18"></line>
                        </svg>
                        Ø§Ù„ÙˆØµÙ
                    </label>
                    <textarea name="description" id="edit-task-description" class="edit-form-textarea" placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ù‡Ù…Ø©" rows="3"></textarea>
                </div>
                
                <!-- Two Column Layout -->
                <div class="edit-form-row">
                    <!-- Project -->
                    <div class="edit-form-group">
                        <label class="edit-form-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                            Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                        </label>
                        <select name="project" class="edit-form-select" id="edit-project-select" required>
                            <option value="">Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹</option>
                        </select>
                    </div>
                    
                    <!-- Priority -->
                    <div class="edit-form-group">
                        <label class="edit-form-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                                <line x1="4" y1="22" x2="4" y2="15"></line>
                            </svg>
                            Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
                        </label>
                        <div class="edit-priority-selector">
                            <input type="radio" name="priority" value="low" id="priority-low">
                            <label for="priority-low" class="priority-option priority-low">
                                <span class="priority-dot"></span>
                                Ù…Ù†Ø®ÙØ¶Ø©
                            </label>
                            <input type="radio" name="priority" value="medium" id="priority-medium">
                            <label for="priority-medium" class="priority-option priority-medium">
                                <span class="priority-dot"></span>
                                Ù…ØªÙˆØ³Ø·Ø©
                            </label>
                            <input type="radio" name="priority" value="high" id="priority-high">
                            <label for="priority-high" class="priority-option priority-high">
                                <span class="priority-dot"></span>
                                Ø¹Ø§Ù„ÙŠØ©
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Status & Due Date Row -->
                <div class="edit-form-row">
                    <!-- Status -->
                    <div class="edit-form-group">
                        <label class="edit-form-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Ø§Ù„Ø­Ø§Ù„Ø©
                        </label>
                        <div class="edit-status-selector" id="edit-task-status">
                            <button type="button" class="status-btn status-todo" data-status="todo">
                                <span class="status-icon">â³</span>
                                Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                            </button>
                            <button type="button" class="status-btn status-progress" data-status="in_progress">
                                <span class="status-icon">ğŸ”„</span>
                                Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
                            </button>
                            <button type="button" class="status-btn status-done" data-status="done">
                                <span class="status-icon">âœ…</span>
                                Ù…ÙƒØªÙ…Ù„
                            </button>
                        </div>
                        <input type="hidden" name="status" id="edit-task-status-value" value="todo">
                    </div>
                    
                    <!-- Due Date -->
                    <div class="edit-form-group">
                        <label class="edit-form-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚
                        </label>
                        <input type="date" name="due_date" id="edit-task-due-date" class="edit-form-input edit-date-input">
                    </div>
                </div>
                
                <!-- Footer Actions -->
                <div class="edit-modal-footer">
                    <button type="button" class="edit-btn edit-btn-cancel" onclick="closeEditModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" class="edit-btn edit-btn-save">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Status Change Modal - Modern UI -->
<div class="status-modal-overlay" id="status-change-modal">
    <div class="status-modal-container">
        <div class="status-modal-glow"></div>
        
        <div class="status-modal-card">
            <div class="status-modal-header">
                <div class="status-modal-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="status-modal-title">
                    <h3>ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©</h3>
                    <p id="status-task-name">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
                </div>
                <button class="status-modal-close" onclick="closeStatusModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <input type="hidden" id="status-change-task-id">
            
            <div class="status-options">
                <button class="status-option-card" data-status="todo" onclick="selectStatus('todo')">
                    <div class="status-option-icon todo">
                        <span>â³</span>
                    </div>
                    <div class="status-option-info">
                        <h4>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h4>
                        <p>Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯</p>
                    </div>
                    <div class="status-check">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                </button>
                
                <button class="status-option-card" data-status="in_progress" onclick="selectStatus('in_progress')">
                    <div class="status-option-icon progress">
                        <span>ğŸ”„</span>
                    </div>
                    <div class="status-option-info">
                        <h4>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h4>
                        <p>Ø§Ù„Ø¹Ù…Ù„ Ø¬Ø§Ø±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø©</p>
                    </div>
                    <div class="status-check">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                </button>
                
                <button class="status-option-card" data-status="done" onclick="selectStatus('done')">
                    <div class="status-option-icon done">
                        <span>âœ…</span>
                    </div>
                    <div class="status-option-info">
                        <h4>Ù…ÙƒØªÙ…Ù„</h4>
                        <p>ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­</p>
                    </div>
                    <div class="status-check">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                </button>
            </div>
            
            <div class="status-modal-footer">
                <button class="status-btn-cancel" onclick="closeStatusModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="status-btn-confirm" id="confirm-status-btn" onclick="confirmStatusChange()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Status Change Modal Styles */
.status-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 15, 30, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    z-index: 2500;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.status-modal-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.status-modal-container {
    position: relative;
    width: 100%;
    max-width: 420px;
}

.status-modal-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(114, 137, 218, 0.4) 0%, transparent 70%);
    pointer-events: none;
    animation: glowPulse 2s ease-in-out infinite;
}

@keyframes glowPulse {
    0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.15); }
}

.status-modal-card {
    position: relative;
    background: linear-gradient(160deg, rgba(25, 35, 55, 0.98), rgba(15, 25, 45, 0.99));
    border: 1px solid rgba(114, 137, 218, 0.3);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 
        0 30px 60px rgba(0, 0, 0, 0.5),
        0 0 50px rgba(114, 137, 218, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    animation: cardPopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes cardPopIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.status-modal-header {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 20px 24px;
    background: linear-gradient(135deg, rgba(114, 137, 218, 0.15), rgba(78, 93, 148, 0.1));
    border-bottom: 1px solid rgba(114, 137, 218, 0.2);
}

.status-modal-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #7289DA, #5B6EAE);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 20px rgba(114, 137, 218, 0.4);
}

.status-modal-icon svg {
    width: 24px;
    height: 24px;
    color: white;
}

.status-modal-title h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: #fff;
}

.status-modal-title p {
    margin: 4px 0 0;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.5);
}

.status-modal-close {
    margin-right: auto;
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.status-modal-close svg {
    width: 18px;
    height: 18px;
}

.status-modal-close:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.5);
    color: #ef4444;
    transform: rotate(90deg);
}

/* Status Options */
.status-options {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.status-option-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 18px;
    background: rgba(255, 255, 255, 0.03);
    border: 2px solid rgba(255, 255, 255, 0.08);
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: right;
}

.status-option-card:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.15);
    transform: translateX(-4px);
}

.status-option-card.selected {
    border-color: var(--selected-color, #7289DA);
    background: var(--selected-bg, rgba(114, 137, 218, 0.15));
    box-shadow: 0 0 20px var(--selected-glow, rgba(114, 137, 218, 0.2));
}

.status-option-card[data-status="todo"].selected {
    --selected-color: #FFC107;
    --selected-bg: rgba(255, 193, 7, 0.15);
    --selected-glow: rgba(255, 193, 7, 0.2);
}

.status-option-card[data-status="in_progress"].selected {
    --selected-color: #4A90E2;
    --selected-bg: rgba(74, 144, 226, 0.15);
    --selected-glow: rgba(74, 144, 226, 0.2);
}

.status-option-card[data-status="done"].selected {
    --selected-color: #4CAF50;
    --selected-bg: rgba(76, 175, 80, 0.15);
    --selected-glow: rgba(76, 175, 80, 0.2);
}

/* Current status indicator */
.status-option-card.current::before {
    content: 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©';
    position: absolute;
    top: -10px;
    right: 12px;
    padding: 2px 10px;
    font-size: 10px;
    font-weight: 600;
    background: var(--selected-color, #7289DA);
    color: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.status-option-card {
    position: relative;
}

.status-option-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
}

.status-option-icon.todo {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.2));
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.status-option-icon.progress {
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.2), rgba(33, 150, 243, 0.2));
    border: 1px solid rgba(74, 144, 226, 0.3);
}

.status-option-icon.done {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(67, 160, 71, 0.2));
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.status-option-info {
    flex: 1;
}

.status-option-info h4 {
    margin: 0;
    font-size: 15px;
    font-weight: 600;
    color: #fff;
}

.status-option-info p {
    margin: 4px 0 0;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.5);
}

.status-check {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
}

.status-check svg {
    width: 16px;
    height: 16px;
    color: #fff;
}

.status-option-card.selected .status-check {
    opacity: 1;
    transform: scale(1);
    background: var(--selected-color, #7289DA);
    border-color: var(--selected-color, #7289DA);
}

/* Footer */
.status-modal-footer {
    display: flex;
    gap: 12px;
    padding: 16px 20px 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
}

.status-btn-cancel,
.status-btn-confirm {
    flex: 1;
    padding: 14px 20px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.status-btn-cancel {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
}

.status-btn-cancel:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}

.status-btn-confirm {
    background: linear-gradient(135deg, #7289DA, #5B6EAE);
    color: white;
    box-shadow: 0 6px 20px rgba(114, 137, 218, 0.4);
}

.status-btn-confirm:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(114, 137, 218, 0.5);
}

.status-btn-confirm:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

@media (max-width: 480px) {
    .status-modal-card {
        border-radius: 16px;
    }
    
    .status-option-card {
        padding: 14px;
    }
    
    .status-option-icon {
        width: 44px;
        height: 44px;
        font-size: 20px;
    }
}
</style>

<style>
/* Edit Modal Styles */
.edit-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 15, 30, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.edit-modal-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.edit-modal-container {
    position: relative;
    width: 100%;
    max-width: 580px;
}

/* Glow Effect */
.edit-modal-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(74, 144, 226, 0.3) 0%, transparent 70%);
    pointer-events: none;
    animation: pulseGlow 3s ease-in-out infinite;
}

@keyframes pulseGlow {
    0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); }
}

/* Floating Particles */
.edit-modal-particles {
    position: absolute;
    width: 100%;
    height: 100%;
    overflow: hidden;
    pointer-events: none;
}

.edit-modal-particles span {
    position: absolute;
    width: 6px;
    height: 6px;
    background: rgba(74, 144, 226, 0.6);
    border-radius: 50%;
    animation: floatParticle 4s ease-in-out infinite;
}

.edit-modal-particles span:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
.edit-modal-particles span:nth-child(2) { top: 20%; right: 15%; animation-delay: 0.5s; }
.edit-modal-particles span:nth-child(3) { bottom: 30%; left: 20%; animation-delay: 1s; }
.edit-modal-particles span:nth-child(4) { bottom: 15%; right: 10%; animation-delay: 1.5s; }
.edit-modal-particles span:nth-child(5) { top: 50%; left: 5%; animation-delay: 2s; }

@keyframes floatParticle {
    0%, 100% { transform: translateY(0) scale(1); opacity: 0.6; }
    50% { transform: translateY(-20px) scale(1.2); opacity: 1; }
}

/* Main Card */
.edit-modal-card {
    position: relative;
    background: linear-gradient(145deg, rgba(30, 40, 60, 0.95), rgba(20, 30, 50, 0.98));
    border: 1px solid rgba(74, 144, 226, 0.3);
    border-radius: 24px;
    padding: 0;
    overflow: hidden;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.5),
        0 0 40px rgba(74, 144, 226, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    animation: modalCardSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalCardSlide {
    from {
        opacity: 0;
        transform: translateY(-40px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Header */
.edit-modal-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 24px 28px;
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.15), rgba(114, 137, 218, 0.1));
    border-bottom: 1px solid rgba(74, 144, 226, 0.2);
}

.edit-modal-icon {
    width: 52px;
    height: 52px;
    background: linear-gradient(135deg, #4A90E2, #7289DA);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(74, 144, 226, 0.4);
}

.edit-modal-icon svg {
    width: 26px;
    height: 26px;
    color: white;
}

.edit-modal-title-section h2 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.edit-modal-title-section p {
    margin: 4px 0 0;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.6);
}

.edit-modal-close {
    margin-right: auto;
    width: 40px;
    height: 40px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.edit-modal-close svg {
    width: 20px;
    height: 20px;
}

.edit-modal-close:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.5);
    color: #ef4444;
    transform: rotate(90deg);
}

/* Form Styles */
.edit-modal-form {
    padding: 28px;
    max-height: calc(85vh - 120px);
    overflow-y: auto;
}

.edit-form-group {
    margin-bottom: 20px;
}

.edit-form-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 10px;
}

.edit-form-label svg {
    color: #4A90E2;
}

.edit-form-input,
.edit-form-textarea,
.edit-form-select {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: #fff;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.3s ease;
}

.edit-form-input:focus,
.edit-form-textarea:focus,
.edit-form-select:focus {
    outline: none;
    border-color: #4A90E2;
    background: rgba(74, 144, 226, 0.1);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
}

.edit-form-input::placeholder,
.edit-form-textarea::placeholder {
    color: rgba(255, 255, 255, 0.35);
}

.edit-form-select option {
    background: #1a2332;
    color: #fff;
}

.edit-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

/* Priority Selector */
.edit-priority-selector {
    display: flex;
    gap: 8px;
}

.edit-priority-selector input[type="radio"] {
    display: none;
}

.priority-option {
    flex: 1;
    padding: 10px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.3s ease;
}

.priority-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.priority-low .priority-dot { background: #4CAF50; }
.priority-medium .priority-dot { background: #FFC107; }
.priority-high .priority-dot { background: #ef4444; }

.priority-option:hover {
    background: rgba(255, 255, 255, 0.1);
}

input[type="radio"]:checked + .priority-low {
    background: rgba(76, 175, 80, 0.2);
    border-color: #4CAF50;
    color: #4CAF50;
}

input[type="radio"]:checked + .priority-medium {
    background: rgba(255, 193, 7, 0.2);
    border-color: #FFC107;
    color: #FFC107;
}

input[type="radio"]:checked + .priority-high {
    background: rgba(239, 68, 68, 0.2);
    border-color: #ef4444;
    color: #ef4444;
}

/* Status Selector */
.edit-status-selector {
    display: flex;
    gap: 8px;
}

.status-btn {
    flex: 1;
    padding: 12px 10px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.3s ease;
}

.status-btn .status-icon {
    font-size: 18px;
}

.status-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

.status-btn.active.status-todo {
    background: rgba(255, 193, 7, 0.2);
    border-color: #FFC107;
    color: #FFC107;
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
}

.status-btn.active.status-progress {
    background: rgba(74, 144, 226, 0.2);
    border-color: #4A90E2;
    color: #4A90E2;
    box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
}

.status-btn.active.status-done {
    background: rgba(76, 175, 80, 0.2);
    border-color: #4CAF50;
    color: #4CAF50;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}

/* Date Input */
.edit-date-input {
    cursor: pointer;
}

.edit-date-input::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
}

/* Footer */
.edit-modal-footer {
    display: flex;
    gap: 12px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 8px;
}

.edit-btn {
    flex: 1;
    padding: 14px 20px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
    border: none;
}

.edit-btn-cancel {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
}

.edit-btn-cancel:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}

.edit-btn-save {
    background: linear-gradient(135deg, #4A90E2, #7289DA);
    color: white;
    box-shadow: 0 8px 24px rgba(74, 144, 226, 0.4);
}

.edit-btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(74, 144, 226, 0.5);
}

.edit-btn-save:active {
    transform: translateY(0);
}

/* Responsive */
@media (max-width: 600px) {
    .edit-form-row {
        grid-template-columns: 1fr;
    }
    
    .edit-modal-header {
        padding: 20px;
    }
    
    .edit-modal-form {
        padding: 20px;
    }
    
    .edit-priority-selector,
    .edit-status-selector {
        flex-direction: column;
    }
    
    .edit-modal-title-section h2 {
        font-size: 18px;
    }
}

/* Scrollbar */
.edit-modal-form::-webkit-scrollbar {
    width: 6px;
}

.edit-modal-form::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.edit-modal-form::-webkit-scrollbar-thumb {
    background: rgba(74, 144, 226, 0.5);
    border-radius: 3px;
}

.edit-modal-form::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 144, 226, 0.7);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auth Helper
function getAuthHeaders() {
    const token = localStorage.getItem('accessToken');
    return token ? { 'Authorization': 'Bearer ' + token } : {};
}

// Check authentication and redirect if needed
function checkAuth(response) {
    if (response.status === 401 || response.status === 403) {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
        return false;
    }
    return true;
}

// Helper Functions
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : type === 'error' ? 'rgba(255, 111, 97, 0.9)' : 'rgba(74, 144, 226, 0.9)'};
        color: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 3000;
        font-weight: 600;
        animation: slideUp 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Load Tasks
async function loadTasks() {
    const grid = document.getElementById('tasks-grid');
    const statusFilter = document.getElementById('filter-status').value;
    const searchValue = document.getElementById('task-search').value.toLowerCase();
    grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
    
    try {
        const response = await fetch('/api/tasks/', { 
            credentials: 'include',
            headers: getAuthHeaders()
        });
        
        if (!checkAuth(response)) return;
        
        const data = await response.json();
        let tasks = data.results || data;
        
        if (statusFilter !== 'all') {
            tasks = tasks.filter(t => t.status === statusFilter);
        }
        if (searchValue) {
            tasks = tasks.filter(t => t.title.toLowerCase().includes(searchValue) || (t.description||'').toLowerCase().includes(searchValue));
        }
        
        if (tasks.length === 0) {
            grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</div>';
            return;
        }
        
        grid.innerHTML = tasks.map(task => {
            const statusLabel = task.status === 'todo' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : task.status === 'in_progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' : 'Ù…ÙƒØªÙ…Ù„';
            const statusClass = task.status === 'done' ? 'success' : task.status === 'in_progress' ? 'warning' : 'secondary';
            const isCompleted = task.status === 'done';
            
            return `
            <div class="task-card ${isCompleted ? 'completed' : ''}">
                <div class="task-header">
                    <div>
                        <h3 class="task-title" style="${isCompleted ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${task.title}</h3>
                        <span class="badge badge-${task.priority === 'high' ? 'accent' : task.priority === 'medium' ? 'warning' : 'success'}">
                            ${task.priority === 'high' ? 'Ø¹Ø§Ù„ÙŠØ©' : task.priority === 'medium' ? 'Ù…ØªÙˆØ³Ø·Ø©' : 'Ù…Ù†Ø®ÙØ¶Ø©'}
                        </span>
                    </div>
                    <div class="task-status-toggle">
                        <button class="btn btn-small ${isCompleted ? 'btn-success' : 'btn-secondary'}" 
                                onclick="toggleTaskStatus('${task.id}', '${task.status}')" 
                                title="${isCompleted ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ÙƒØªÙ…Ø§Ù„' : 'ØªÙ…ÙŠÙŠØ² ÙƒÙ…ÙƒØªÙ…Ù„'}">
                            ${isCompleted ? 'âœ“ Ù…ÙƒØªÙ…Ù„' : 'â—‹ Ø¥ÙƒÙ…Ø§Ù„'}
                        </button>
                    </div>
                </div>
                <p class="task-description">${task.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                <div class="task-meta">
                    <span>ğŸ“… ${task.due_date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    <span class="badge badge-${statusClass}">${statusLabel}</span>
                </div>
                <div class="task-footer">
                    <button class="btn btn-small btn-secondary" onclick='editTask(${JSON.stringify(task).replace(/'/g, "&#39;")})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn btn-small btn-primary" onclick="changeTaskStatus('${task.id}', '${task.title.replace(/'/g, "\\'")}', '${task.status}')">ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</button>
                    <button class="btn btn-small btn-accent" onclick="deleteTask('${task.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
            </div>
        `}).join('');
    } catch (error) {
        console.error('Error loading tasks:', error);
        grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…</div>';
    }
}

// Load Projects for dropdown
async function loadProjects() {
    try {
        const response = await fetch('/api/projects/', { 
            credentials: 'include',
            headers: getAuthHeaders()
        });
        
        if (!checkAuth(response)) return;
        
        const data = await response.json();
        const projects = data.results || data;
        
        const select = document.getElementById('project-select');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹</option>' + 
            projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

// Create Task
document.getElementById('new-task-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/tasks/', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                ...getAuthHeaders()
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            closeModal('new-task-modal');
            e.target.reset();
            loadTasks();
        } else {
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
        }
    } catch (error) {
        console.error('Error creating task:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
    }
});

// Delete Task
async function deleteTask(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';
    
    try {
        const response = await fetch(`/api/tasks/${id}/`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                ...getAuthHeaders()
            }
        });
        
        if (response.ok || response.status === 204) {
            showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            loadTasks();
        } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('Delete error:', response.status, errorData);
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©: ' + (errorData.detail || response.status), 'error');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
    }
}

// Helper to get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Edit Task - Open modal with task data
function editTask(task) {
    // Fill the edit form with task data
    document.getElementById('edit-task-id').value = task.id;
    document.getElementById('edit-task-title').value = task.title || '';
    document.getElementById('edit-task-description').value = task.description || '';
    document.getElementById('edit-task-due-date').value = task.due_date || '';
    
    // Set priority radio button
    const priorityValue = task.priority || 'medium';
    const priorityRadio = document.querySelector(`input[name="priority"][value="${priorityValue}"]`);
    if (priorityRadio) priorityRadio.checked = true;
    
    // Set status buttons
    const statusValue = task.status || 'todo';
    document.getElementById('edit-task-status-value').value = statusValue;
    setActiveStatusButton(statusValue);
    
    // Load projects into edit dropdown
    loadProjectsForEdit(task.project);
    
    // Open the new modal
    openEditModal();
}

// Open Edit Modal
function openEditModal() {
    document.getElementById('edit-task-modal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

// Close Edit Modal
function closeEditModal() {
    const modal = document.getElementById('edit-task-modal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

// Set active status button
function setActiveStatusButton(status) {
    document.querySelectorAll('.status-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) {
            btn.classList.add('active');
        }
    });
}

// Initialize status buttons click handlers
document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const status = this.dataset.status;
        document.getElementById('edit-task-status-value').value = status;
        setActiveStatusButton(status);
    });
});

// Close modal on overlay click
document.getElementById('edit-task-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
        closeStatusModal();
    }
});

// Load projects for edit dropdown
async function loadProjectsForEdit(selectedProject) {
    try {
        const response = await fetch('/api/projects/', { 
            credentials: 'include',
            headers: getAuthHeaders()
        });
        
        if (!checkAuth(response)) return;
        
        const data = await response.json();
        const projects = data.results || data;
        
        const select = document.getElementById('edit-project-select');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹</option>' + 
            projects.map(p => `<option value="${p.id}" ${p.id == selectedProject ? 'selected' : ''}>${p.name}</option>`).join('');
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

// Submit edit form
document.getElementById('edit-task-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const taskId = document.getElementById('edit-task-id').value;
    const data = {
        title: formData.get('title'),
        description: formData.get('description'),
        project: formData.get('project'),
        priority: formData.get('priority'),
        status: document.getElementById('edit-task-status-value').value,
        due_date: formData.get('due_date') || null
    };
    
    try {
        const response = await fetch(`/api/tasks/${taskId}/`, {
            method: 'PATCH',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                ...getAuthHeaders()
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            closeEditModal();
            loadTasks();
        } else {
            const error = await response.json();
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©: ' + (error.detail || 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'), 'error');
        }
    } catch (error) {
        console.error('Error updating task:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
    }
});

// Toggle task completion status
async function toggleTaskStatus(taskId, currentStatus) {
    const newStatus = (currentStatus === 'done') ? 'todo' : 'done';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';
    
    try {
        const response = await fetch(`/api/tasks/${taskId}/`, {
            method: 'PATCH',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                ...getAuthHeaders()
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (response.ok) {
            showToast(newStatus === 'done' ? 'ØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù‡Ù…Ø© ÙƒÙ…ÙƒØªÙ…Ù„Ø© âœ“' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ÙƒØªÙ…Ø§Ù„', 'success');
            loadTasks();
        } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('Toggle error:', response.status, errorData);
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
        }
    } catch (error) {
        console.error('Error toggling task status:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
    }
}

// Change task status with options
let selectedNewStatus = null;

function changeTaskStatus(taskId, taskTitle = '', currentStatus = '') {
    // Open the status modal
    document.getElementById('status-change-task-id').value = taskId;
    document.getElementById('status-task-name').textContent = taskTitle || 'Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
    
    // Reset all cards first
    document.querySelectorAll('.status-option-card').forEach(card => {
        card.classList.remove('selected', 'current');
    });
    
    // Mark current status as selected and current
    if (currentStatus) {
        selectedNewStatus = currentStatus;
        const currentCard = document.querySelector(`.status-option-card[data-status="${currentStatus}"]`);
        if (currentCard) {
            currentCard.classList.add('selected', 'current');
        }
        document.getElementById('confirm-status-btn').disabled = false;
    } else {
        selectedNewStatus = null;
        document.getElementById('confirm-status-btn').disabled = true;
    }
    
    // Open modal
    openStatusModal();
}

function openStatusModal() {
    document.getElementById('status-change-modal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeStatusModal() {
    document.getElementById('status-change-modal').classList.remove('active');
    document.body.style.overflow = '';
    selectedNewStatus = null;
}

function selectStatus(status) {
    selectedNewStatus = status;
    
    // Update UI
    document.querySelectorAll('.status-option-card').forEach(card => {
        card.classList.remove('selected');
        if (card.dataset.status === status) {
            card.classList.add('selected');
        }
    });
    
    document.getElementById('confirm-status-btn').disabled = false;
}

async function confirmStatusChange() {
    if (!selectedNewStatus) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø§Ù„Ø©', 'error');
        return;
    }
    
    const taskId = document.getElementById('status-change-task-id').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';
    
    try {
        const response = await fetch(`/api/tasks/${taskId}/`, {
            method: 'PATCH',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                ...getAuthHeaders()
            },
            body: JSON.stringify({ status: selectedNewStatus })
        });
        
        if (response.ok) {
            const statusNames = {
                'todo': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                'in_progress': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
                'done': 'Ù…ÙƒØªÙ…Ù„'
            };
            showToast(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰: ${statusNames[selectedNewStatus]} âœ“`, 'success');
            closeStatusModal();
            loadTasks();
        } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('Status change error:', response.status, errorData);
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©: ' + (errorData.detail || response.status), 'error');
        }
    } catch (error) {
        console.error('Error changing task status:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
    }
}

// Close status modal on overlay click
document.getElementById('status-change-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeStatusModal();
    }
});

// Event Listeners
document.getElementById('new-task-btn').addEventListener('click', () => openModal('new-task-modal'));
document.getElementById('filter-status').addEventListener('change', loadTasks);
document.getElementById('task-search').addEventListener('input', loadTasks);

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadTasks();
    loadProjects();
});
</script>
{% endblock %}
